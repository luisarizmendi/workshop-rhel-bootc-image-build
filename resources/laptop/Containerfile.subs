FROM registry.redhat.io/rhel9/rhel-bootc:9.6
ARG RH_USERNAME=""
ARG RH_PASSWORD=""
RUN if [ -n "$RH_USERNAME" ] && [ -n "$RH_PASSWORD" ]; then     echo "Registering with Red Hat subscription manager..."  && rm -rf /etc/rhsm-host && subscription-manager register --username "$RH_USERNAME" --password "$RH_PASSWORD" | tee /tmp/register_output && echo $(grep -o 'ID: [a-f0-9-]*' /tmp/register_output | cut -d' ' -f2) > /etc/rhsm/system_id && echo $(grep -o 'system name is: [a-f0-9-]*' /tmp/register_output | cut -d' ' -f4) > /etc/rhsm/host_id && rm -f /tmp/register_output ;     else     echo "Red Hat credentials not found; skipping subscription registration.";     fi
RUN dnf -y --nogpgcheck install curl jq && dnf clean all
RUN mkdir -p /entitlements && cp -a /etc/pki/entitlement/* /entitlements/
RUN if [ -n "$RH_USERNAME" ] && [ -n "$RH_PASSWORD" ]; then     echo "Unregistering from Red Hat Cloud inventory..." && for uuid in $(curl -s -u "$RH_USERNAME:$RH_PASSWORD" https://cloud.redhat.com/api/inventory/v1/hosts?fqdn=$(cat /etc/rhsm/host_id) | grep -o '"id":"[^"]*' | grep -o '[^"]*$') ; do curl -u "$RH_USERNAME:$RH_PASSWORD" -X DELETE https://cloud.redhat.com/api/inventory/v1/hosts/$uuid -H  "accept: */*" ;done && subscription-manager unregister && subscription-manager clean && ln -s /run/secrets/rhsm /etc/rhsm-host;     else     echo "Red Hat credentials not found; skipping subscription clean-up.";     fi
